<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Регистрация</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .auth-card {
            max-width: 500px;
        }
    </style>
</head>
<body class="bg-light">
<div id="app" class="container py-5"></div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const errors = {
            general: urlParams.get('error'),
            username: urlParams.get('usernameError'),
            password: urlParams.get('passwordError')
        };

        const container = document.getElementById('app');

        // Создание карточки
        const card = document.createElement('div');
        card.className = 'card shadow-sm mx-auto auth-card';

        const cardBody = document.createElement('div');
        cardBody.className = 'card-body p-5';

        // Заголовок
        const title = document.createElement('h1');
        title.className = 'h3 mb-4 text-center';
        title.textContent = 'Регистрация';
        cardBody.appendChild(title);

        // Отображение ошибок
        if (errors.general) {
            const alert = createAlert(errors.general, 'danger');
            cardBody.appendChild(alert);
        }

        // Форма регистрации
        const form = document.createElement('form');
        form.onsubmit = handleSubmit;

        // Поле логина
        form.appendChild(createInputGroup(
            'username',
            'Логин:',
            'text',
            errors.username,
            'Введите корректный логин'
        ));

        // Поле пароля
        form.appendChild(createInputGroup(
            'password',
            'Пароль:',
            'password',
            errors.password,
            'Минимум 4 символа'
        ));

        // Кнопки
        const submitButton = createButton(
            'Зарегистрироваться',
            'person-plus',
            'submit',
            'primary'
        );

        const loginLink = createButton(
            'Уже есть аккаунт? Войти',
            'box-arrow-in-right',
            'button',
            'outline-secondary',
            '/login'
        );

        const buttonGroup = document.createElement('div');
        buttonGroup.className = 'd-grid gap-2';
        buttonGroup.append(submitButton, loginLink);
        form.appendChild(buttonGroup);

        cardBody.appendChild(form);
        card.appendChild(cardBody);
        container.appendChild(card);

        // Вспомогательные функции
        function createAlert(text, type) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} mb-4`;
            alert.textContent = text;
            return alert;
        }

        function createInputGroup(id, label, type, error, helpText) {
            const group = document.createElement('div');
            group.className = 'mb-3';

            // Лейбл
            const labelEl = document.createElement('label');
            labelEl.className = 'form-label';
            labelEl.textContent = label;
            labelEl.htmlFor = id;
            group.appendChild(labelEl);

            // Инпут
            const input = document.createElement('input');
            input.className = 'form-control';
            input.id = id;
            input.type = type;
            input.required = true;
            group.appendChild(input);

            // Подсказка/ошибка
            if (error) {
                const errorEl = document.createElement('div');
                errorEl.className = 'text-danger small mt-1';
                errorEl.textContent = error;
                group.appendChild(errorEl);
            } else if (helpText) {
                const helpEl = document.createElement('small');
                helpEl.className = 'text-muted';
                helpEl.textContent = helpText;
                group.appendChild(helpEl);
            }

            return group;
        }

        function createButton(text, icon, type, style, href) {
            const button = href ? document.createElement('a') : document.createElement('button');
            button.className = `btn btn-${style}`;

            if (href) {
                button.href = href;
                button.role = 'button';
            } else {
                button.type = type;
            }

            const iconEl = document.createElement('i');
            iconEl.className = `bi bi-${icon}`;

            button.appendChild(iconEl);
            button.appendChild(document.createTextNode(` ${text}`));

            return button;
        }

        async function handleSubmit(e) {
            e.preventDefault();

            const formData = {
                username: document.getElementById('username').value,
                password: document.getElementById('password').value
            };

            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    window.location.href = '/login?registered=true';
                } else {
                    const errorData = await response.json();
                    const params = new URLSearchParams(errorData).toString();
                    window.location.href = `/register?${params}`;
                }
            } catch (err) {
                console.error('Ошибка регистрации:', err);
                window.location.href = '/register?error=Ошибка соединения с сервером';
            }
        }
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Административная панель</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <style>
    .sidebar {
      width: 250px;
      background-color: #f8f9fa;
      padding: 20px;
      height: 100vh;
    }
    .main-content {
      flex-grow: 1;
      padding: 20px;
    }
    .navbar {
      background-color: #343a40;
    }
  </style>
</head>
<body>
<nav class="navbar navbar-dark">
  <div class="container-fluid">
    <div class="d-flex align-items-center">
      <span class="text-white me-3" id="currentUserInfo"></span>
    </div>
    <button id="logoutBtn" class="btn btn-outline-light">
      <i class="bi bi-box-arrow-right"></i> Выйти
    </button>
  </div>
</nav>

<div class="d-flex">
  <div class="sidebar">
    <ul class="nav flex-column">
      <li class="nav-item">
        <a href="/admin" class="nav-link active">
          <i class="bi bi-table me-2"></i>Админка
        </a>
      </li>
      <li class="nav-item">
        <a href="/user" class="nav-link">
          <i class="bi bi-person me-2"></i>Профиль
        </a>
      </li>
    </ul>
  </div>

  <div class="main-content">
    <h3 class="mb-4">Административная панель</h3>

    <ul class="nav nav-tabs" id="adminTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="users-tab" data-bs-toggle="tab"
                data-bs-target="#users" type="button" role="tab">Пользователи</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="new-user-tab" data-bs-toggle="tab"
                data-bs-target="#new-user" type="button" role="tab">Новый пользователь</button>
      </li>
    </ul>

    <div class="tab-content" id="adminTabsContent">
      <div class="tab-pane fade show active" id="users" role="tabpanel">
        <div class="mt-4">
          <table class="table table-bordered table-hover">
            <thead class="table-light">
            <tr>
              <th>ID</th>
              <th>Имя</th>
              <th>Фамилия</th>
              <th>Возраст</th>
              <th>Email</th>
              <th>Роли</th>
              <th>Действия</th>
            </tr>
            </thead>
            <tbody id="usersTable">
            <!-- Данные будут загружены через JS -->
            </tbody>
          </table>
        </div>
      </div>

      <div class="tab-pane fade" id="new-user" role="tabpanel">
        <div class="mt-4">
          <form id="createUserForm">
            <div class="mb-3">
              <label for="firstName" class="form-label">Имя</label>
              <input type="text" class="form-control" id="firstName" required>
            </div>
            <div class="mb-3">
              <label for="lastName" class="form-label">Фамилия</label>
              <input type="text" class="form-control" id="lastName" required>
            </div>
            <div class="mb-3">
              <label for="age" class="form-label">Возраст</label>
              <input type="number" class="form-control" id="age" required>
            </div>
            <div class="mb-3">
              <label for="email" class="form-label">Email</label>
              <input type="email" class="form-control" id="email" required>
            </div>
            <div class="mb-3">
              <label for="password" class="form-label">Пароль</label>
              <input type="password" class="form-control" id="password" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Роли</label>
              <div id="rolesCheckboxes">
                <!-- Роли будут загружены через JS -->
              </div>
            </div>
            <button type="submit" class="btn btn-success">Создать пользователя</button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Модальное окно редактирования -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Редактирование пользователя</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="editUserForm">
          <input type="hidden" id="editUserId">
          <div class="mb-3">
            <label for="editFirstName" class="form-label">Имя</label>
            <input type="text" class="form-control" id="editFirstName" required>
          </div>
          <div class="mb-3">
            <label for="editLastName" class="form-label">Фамилия</label>
            <input type="text" class="form-control" id="editLastName" required>
          </div>
          <div class="mb-3">
            <label for="editAge" class="form-label">Возраст</label>
            <input type="number" class="form-control" id="editAge" required>
          </div>
          <div class="mb-3">
            <label for="editEmail" class="form-label">Email</label>
            <input type="email" class="form-control" id="editEmail" required>
          </div>
          <div class="mb-3">
            <label for="editPassword" class="form-label">Пароль (оставьте пустым, чтобы не менять)</label>
            <input type="password" class="form-control" id="editPassword">
          </div>
          <div class="mb-3">
            <label class="form-label">Роли</label>
            <div id="editRolesCheckboxes">
              <!-- Роли будут загружены через JS -->
            </div>
          </div>
          <button type="submit" class="btn btn-primary">Сохранить изменения</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    let allRoles = [];

    // Проверка аутентификации
    fetch('/api/auth/check', {
      method: 'GET',
      headers: {
        'Accept': 'application/json'
      },
      credentials: 'include'
    })
            .then(response => {
              if (!response.ok) {
                window.location.href = '/login';
                throw new Error('Not authenticated');
              }
              return response.json();
            })
            .then(data => {
              if (!data.authenticated || !data.admin) {
                window.location.href = '/access-denied';
              }

              loadAdminData();
            });

    // Обработка выхода
    document.getElementById('logoutBtn').addEventListener('click', function() {
      fetch('/api/logout', {
        method: 'POST',
        credentials: 'include'
      })
              .then(response => {
                if (response.ok) {
                  window.location.href = '/login?logout=true';
                }
              });
    });

    // Обработка создания пользователя
    document.getElementById('createUserForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const selectedRoles = Array.from(document.querySelectorAll('#rolesCheckboxes input[type="checkbox"]:checked'))
              .map(checkbox => checkbox.value);

      const userData = {
        firstName: document.getElementById('firstName').value,
        lastName: document.getElementById('lastName').value,
        age: document.getElementById('age').value,
        email: document.getElementById('email').value,
        password: document.getElementById('password').value,
        roleIds: selectedRoles.map(Number)
      };

      try {
        const response = await fetch('/api/admin/users', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          credentials: 'include',
          body: JSON.stringify(userData)
        });

        if (response.ok) {
          loadAdminData();
          document.getElementById('createUserForm').reset();
          alert('Пользователь успешно создан');
        } else {
          alert('Ошибка при создании пользователя');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Ошибка при создании пользователя');
      }
    });

    // Обработка редактирования пользователя
    document.getElementById('editUserForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const userId = document.getElementById('editUserId').value;
      const selectedRoles = Array.from(document.querySelectorAll('#editRolesCheckboxes input[type="checkbox"]:checked'))
              .map(checkbox => checkbox.value);

      const userData = {
        firstName: document.getElementById('editFirstName').value,
        lastName: document.getElementById('editLastName').value,
        age: document.getElementById('editAge').value,
        email: document.getElementById('editEmail').value,
        password: document.getElementById('editPassword').value || null,
        roleIds: selectedRoles.map(Number)
      };

      try {
        const response = await fetch(`/api/admin/users/${userId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          credentials: 'include',
          body: JSON.stringify(userData)
        });

        if (response.ok) {
          loadAdminData();
          const modal = bootstrap.Modal.getInstance(document.getElementById('editUserModal'));
          modal.hide();
          alert('Изменения сохранены');
        } else {
          alert('Ошибка при обновлении пользователя');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Ошибка при обновлении пользователя');
      }
    });

    // Делегирование событий для кнопок редактирования и удаления
    document.getElementById('usersTable').addEventListener('click', async function(e) {
      if (e.target.classList.contains('edit-btn')) {
        const userId = e.target.dataset.id;
        await loadUserForEdit(userId);
      }

      if (e.target.classList.contains('delete-btn')) {
        const userId = e.target.dataset.id;
        if (confirm('Вы уверены, что хотите удалить этого пользователя?')) {
          const response = await fetch(`/api/admin/users/${userId}`, {
            method: 'DELETE',
            credentials: 'include'
          });

          if (response.ok) {
            loadAdminData();
            alert('Пользователь удален');
          }
        }
      }
    });
  });

  async function loadAdminData() {
    try {
      const response = await fetch('/api/admin/users', {
        method: 'GET',
        headers: {
          'Accept': 'application/json'
        },
        credentials: 'include'
      });

      if (!response.ok) {
        if (response.status === 403) {
          window.location.href = '/access-denied';
        } else {
          throw new Error('Failed to load admin data');
        }
      }

      const data = await response.json();

      // Отображаем информацию о текущем пользователе
      const roles = data.roles.join(', ').replace(/ROLE_/g, '');
      document.getElementById('currentUserInfo').textContent =
              `${data.email} (${roles})`;

      // Сохраняем роли для использования в формах
      allRoles = data.allRoles;

      // Заполняем чекбоксы ролей
      renderRoleCheckboxes(allRoles);

      // Заполняем таблицу пользователей
      renderUsersTable(data.users);
    } catch (error) {
      console.error('Error loading admin data:', error);
      window.location.href = '/login';
    }
  }

  function renderRoleCheckboxes(roles) {
    const rolesContainer = document.getElementById('rolesCheckboxes');
    const editRolesContainer = document.getElementById('editRolesCheckboxes');

    rolesContainer.innerHTML = '';
    editRolesContainer.innerHTML = '';

    roles.forEach(role => {
      const roleId = role.replace('ROLE_', '').toLowerCase();
      const roleName = role.replace('ROLE_', '');

      // Для формы создания
      const checkbox = document.createElement('div');
      checkbox.className = 'form-check';
      checkbox.innerHTML = `
                <input class="form-check-input" type="checkbox" value="${role}" id="role-${roleId}">
                <label class="form-check-label" for="role-${roleId}">
                    ${roleName}
                </label>
            `;
      rolesContainer.appendChild(checkbox);

      // Для формы редактирования
      const editCheckbox = checkbox.cloneNode(true);
      editCheckbox.id = `edit-role-${roleId}`;
      editRolesContainer.appendChild(editCheckbox);
    });
  }

  function renderUsersTable(users) {
    const tableBody = document.getElementById('usersTable');
    tableBody.innerHTML = '';

    users.forEach(user => {
      const row = document.createElement('tr');
      const roles = user.roles.join(', ').replace(/ROLE_/g, '');

      row.innerHTML = `
                <td>${user.id}</td>
                <td>${user.firstName}</td>
                <td>${user.lastName}</td>
                <td>${user.age}</td>
                <td>${user.email}</td>
                <td>${roles}</td>
                <td>
                    <button class="btn btn-sm btn-primary edit-btn" data-id="${user.id}">Редактировать</button>
                    <button class="btn btn-sm btn-danger delete-btn" data-id="${user.id}">Удалить</button>
                </td>
            `;

      tableBody.appendChild(row);
    });
  }

  async function loadUserForEdit(userId) {
    try {
      const response = await fetch(`/api/admin/users/${userId}`, {
        method: 'GET',
        headers: {
          'Accept': 'application/json'
        },
        credentials: 'include'
      });

      if (!response.ok) throw new Error('Failed to load user data');

      const user = await response.json();

      // Заполняем форму редактирования
      document.getElementById('editUserId').value = user.id;
      document.getElementById('editFirstName').value = user.firstName;
      document.getElementById('editLastName').value = user.lastName;
      document.getElementById('editAge').value = user.age;
      document.getElementById('editEmail').value = user.email;
      document.getElementById('editPassword').value = '';

      // Устанавливаем чекбоксы ролей
      const checkboxes = document.querySelectorAll('#editRolesCheckboxes input[type="checkbox"]');
      checkboxes.forEach(checkbox => {
        checkbox.checked = user.roles.includes(checkbox.value);
      });

      // Показываем модальное окно
      const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
      modal.show();
    } catch (error) {
      console.error('Error loading user for edit:', error);
    }
  }
</script>
</body>
</html>
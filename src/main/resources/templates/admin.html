<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>User Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .navbar-dark { background-color: #1a1a1a; padding: 12px 20px; }
        .sidebar { background-color: #2c3e50; min-height: 100vh; width: 240px; padding: 20px; }
        .nav-link { color: #ecf0f1 !important; padding: 12px 16px; margin: 6px 0; border-radius: 6px; transition: all 0.3s; }
        .nav-link:hover { background-color: #34495e; }
        .main-content { padding: 24px; flex-grow: 1; background-color: #f8f9fa; }
        .table-hover tbody tr { transition: all 0.2s; }
        .alert-position { position: fixed; top: 20px; right: 20px; z-index: 1050; }
        .spinner { width: 1.5rem; height: 1.5rem; }
    </style>
</head>
<body>
<nav class="navbar navbar-dark">
    <div class="container-fluid">
        <span class="navbar-brand">User Management</span>
        <div id="userInfo" class="text-white"></div>
        <button class="btn btn-outline-light" id="logoutBtn">
            <i class="fas fa-sign-out-alt"></i> Logout
        </button>
    </div>
</nav>

<div class="d-flex">
    <aside class="sidebar bg-dark" id="sidebar">
        <nav class="nav flex-column">
            <a class="nav-link active" href="#" data-view="dashboard">
                <i class="fas fa-home me-2"></i>Dashboard
            </a>
            <a class="nav-link" href="#" data-view="users">
                <i class="fas fa-users me-2"></i>Manage Users
            </a>
        </nav>
    </aside>

    <main class="main-content" id="mainContent">
        <div class="card shadow-sm">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4 class="mb-0">User List</h4>
                    <button class="btn btn-primary" id="addUserBtn">
                        <i class="fas fa-plus me-2"></i>New User
                    </button>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover align-middle" id="usersTable">
                        <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>First Name</th>
                            <th>Last Name</th>
                            <th>Age</th>
                            <th>Email</th>
                            <th>Roles</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        <!-- Users will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>
</div>

<div id="modalsContainer"></div>
<div id="alertsContainer" class="alert-position"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    class UserAPI {
        static async getAll() {
            try {
                const response = await fetch('/api/admin/users');
                return await response.json();
            } catch (error) {
                throw new Error('Failed to fetch users');
            }
        }

        static async getById(id) {
            try {
                const response = await fetch(`/api/admin/users/${id}`);
                return await response.json();
            } catch (error) {
                throw new Error('Failed to fetch user');
            }
        }

        static async create(userData) {
            try {
                const response = await fetch('/api/admin/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userData)
                });
                return await response.json();
            } catch (error) {
                throw new Error('Failed to create user');
            }
        }

        static async update(id, userData) {
            try {
                const response = await fetch(`/api/admin/users/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userData)
                });
                return await response.json();
            } catch (error) {
                throw new Error('Failed to update user');
            }
        }

        static async delete(id) {
            try {
                const response = await fetch(`/api/admin/users/${id}`, {
                    method: 'DELETE'
                });
                return response.ok;
            } catch (error) {
                throw new Error('Failed to delete user');
            }
        }

        static async getRoles() {
            try {
                const response = await fetch('/api/admin/roles');
                return await response.json();
            } catch (error) {
                throw new Error('Failed to fetch roles');
            }
        }
    }

    class UIComponent {
        static showAlert(message, type = 'success') {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.getElementById('alertsContainer').appendChild(alert);
            setTimeout(() => alert.remove(), 5000);
        }

        static renderUserForm(user = null) {
            const isEdit = !!user;
            return `
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h4 class="mb-4">${isEdit ? 'Edit User' : 'Create New User'}</h4>
                        <form id="userForm">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">First Name</label>
                                    <input type="text" class="form-control" id="firstName"
                                        value="${user?.firstName || ''}" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Last Name</label>
                                    <input type="text" class="form-control" id="lastName"
                                        value="${user?.lastName || ''}" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Age</label>
                                    <input type="number" class="form-control" id="age"
                                        value="${user?.age || ''}" min="1" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Email</label>
                                    <input type="email" class="form-control" id="email"
                                        value="${user?.email || ''}" required>
                                </div>
                                <div class="col-12">
                                    <label class="form-label">Password</label>
                                    <input type="password" class="form-control" id="password"
                                        ${isEdit ? 'placeholder="Leave blank to keep unchanged"' : 'required'}>
                                </div>
                                <div class="col-12">
                                    <label class="form-label">Roles</label>
                                    <select class="form-select" multiple size="3" id="roles" required>
                                        ${window.roles.map(role => `
                                            <option value="${role}"
                                                ${user?.roles?.includes(role) ? 'selected' : ''}>
                                                ${role}
                                            </option>
                                        `).join('')}
                                    </select>
                                </div>
                                <div class="col-12">
                                    <button type="submit" class="btn btn-primary">
                                        ${isEdit ? 'Update User' : 'Create User'}
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary ms-2"
                                        onclick="location.reload()">
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }
    }

    let roles = [];

    async function loadRoles() {
        try {
            roles = await UserAPI.getRoles();
        } catch (error) {
            UIComponent.showAlert(error.message, 'danger');
        }
    }

    async function loadUsers() {
        try {
            const users = await UserAPI.getAll();
            renderUsers(users);
        } catch (error) {
            UIComponent.showAlert(error.message, 'danger');
        }
    }

    function renderUsers(users) {
        const tbody = document.querySelector('#usersTable tbody');
        tbody.innerHTML = users.map(user => `
            <tr>
                <td>${user.id}</td>
                <td>${user.firstName}</td>
                <td>${user.lastName}</td>
                <td>${user.age}</td>
                <td>${user.email}</td>
                <td>${user.roles.join(', ')}</td>
                <td>
                    <button class="btn btn-sm btn-warning me-2" onclick="showEditForm(${user.id})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteUser(${user.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }

    async function showEditForm(userId) {
        try {
            const user = await UserAPI.getById(userId);
            const formHtml = UIComponent.renderUserForm(user);
            document.getElementById('mainContent').innerHTML = formHtml;
            initFormHandler(userId);
        } catch (error) {
            UIComponent.showAlert(error.message, 'danger');
        }
    }

    function initFormHandler(userId = null) {
        const form = document.getElementById('userForm');
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const userData = {
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                age: parseInt(document.getElementById('age').value),
                email: document.getElementById('email').value,
                password: document.getElementById('password').value,
                roles: Array.from(document.getElementById('roles').selectedOptions)
                    .map(option => option.value)
            };

            try {
                if (userId) {
                    await UserAPI.update(userId, userData);
                } else {
                    await UserAPI.create(userData);
                }
                UIComponent.showAlert(`User ${userId ? 'updated' : 'created'} successfully!`, 'success');
                loadUsers();
                document.getElementById('mainContent').innerHTML = '';
            } catch (error) {
                UIComponent.showAlert(error.message, 'danger');
            }
        });
    }

    async function deleteUser(userId) {
        if (confirm('Are you sure you want to delete this user?')) {
            try {
                await UserAPI.delete(userId);
                UIComponent.showAlert('User deleted successfully', 'success');
                loadUsers();
            } catch (error) {
                UIComponent.showAlert(error.message, 'danger');
            }
        }
    }

    document.getElementById('addUserBtn').addEventListener('click', () => {
        const formHtml = UIComponent.renderUserForm();
        document.getElementById('mainContent').innerHTML = formHtml;
        initFormHandler();
    });

    document.getElementById('logoutBtn').addEventListener('click', () => {
        fetch('/logout', { method: 'POST' })
            .then(() => window.location.href = '/login')
            .catch(error => console.error('Logout failed:', error));
    });

    // Initial load
    (async () => {
        await loadRoles();
        await loadUsers();
    })();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Админ панель</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .navbar-dark {
      background-color: #000 !important;
      padding: 10px 20px;
    }
    .sidebar {
      background-color: #007bff;
      min-height: 100vh;
      width: 200px;
      padding: 20px;
      color: white;
    }
    .sidebar .nav-link {
      background-color: rgba(255, 255, 255, 0.2);
      color: white !important;
      padding: 10px 15px;
      margin: 5px 0;
      border-radius: 5px;
    }
    .sidebar .nav-link:hover {
      background-color: rgba(255, 255, 255, 0.3);
    }
    .sidebar .nav-link.active {
      background-color: rgba(255, 255, 255, 0.4);
    }
    .main-content {
      padding: 20px;
      flex-grow: 1;
    }
    .table thead th {
      background-color: #f8f9fa;
      border-bottom: 2px solid #dee2e6;
    }
    .admin-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid #dee2e6;
      margin-bottom: 20px;
    }
    .nav-tabs {
      margin-bottom: 20px;
    }
    .tab-content {
      background-color: white;
      padding: 20px;
      border: 1px solid #dee2e6;
      border-top: none;
      border-radius: 0 0 5px 5px;
    }
    .table {
      margin-top: 20px;
    }
    .admin-panel {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding-top: 20px;
    }
    .form-container {
      width: 400px;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .form-group {
      width: 300px;
      text-align: left;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .form-group label {
      font-weight: bold;
      display: block;
      margin-bottom: 5px;
      text-align: center;
      width: 100%;
    }
    .button-container {
      display: flex;
      justify-content: center;
      width: 100%;
      padding: 10px;
      box-sizing: border-box;
    }
    .button-container button {
      margin: 0 10px;
      padding: 10px 20px;
    }
    .editing {
      background-color: #fdea98;
    }
    .bold {
      font-weight: bold;
    }
    .role-items-container {
      gap: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      margin-top: 8px;
      border: 1px solid #ced4da;
      border-radius: 0.375rem;
      background: #f8f9fa;
      width: 300px;
    }
    .role-item {
      padding: 8px 12px;
      border-radius: 0.25rem;
      transition: all 0.2s ease;
      cursor: pointer;
    }
    .role-item:hover {
      background-color: #e9ecef;
    }
    .role-item.selected {
      color: #fff;
      font-weight: 500;
      background-color: #007bff;
    }
    .d-none {
      display: none;
    }
    .error-message {
      color: red;
      font-size: 0.9em;
      margin-top: 5px;
    }
    .has-error {
      border-color: red;
    }
    .modal-dialog-centered {
      display: flex;
      align-items: center;
      min-height: calc(100% - 1rem);
    }
    .modal-title {
      font-weight: bold;
    }
    .modal-footer {
      justify-content: flex-end;
      padding: 1rem;
    }
    .modal-content {
      width: 100%;
      max-width: 600px;
      margin: 0 auto;
    }
    .bg-light {
      background-color: #e8ebee !important;
      cursor: not-allowed;
    }
    .form-control {
      max-width: 300px;
      width: 100%;
      text-align: left;
      margin: 0 auto;
    }
    .delete-modal .modal-body {
      padding: 20px;
    }
    .delete-modal .row {
      margin-bottom: 10px;
      align-items: center;
    }
    .delete-modal .col-3 {
      font-weight: bold;
      text-align: center;
    }
    .delete-modal .col-9 {
      padding: 8px;
      background-color: #f8f9fa;
      border-radius: 4px;
      text-align: center;
    }
    #rolesError {
      color: #dc3545;
      font-size: 0.875em;
      margin-top: 5px;
      display: none;
    }
    .btn-edit {
      color: #fdfdfd;
      background-color: #17a1b7;
    }
  </style>
</head>
<body>
<nav class="navbar navbar-dark">
  <div class="container-fluid">
    <div class="d-flex align-items-center">
      <span class="text-white me-3" id="currentUserInfo"></span>
    </div>
    <button id="logoutBtn" class="btn btn-outline-light">
      <i class="fas fa-sign-out-alt"></i> Выйти
    </button>
  </div>
</nav>

<div class="d-flex">
  <div class="sidebar">
    <ul class="nav flex-column">
      <li class="nav-item" id="adminLink">
        <a href="/admin" class="nav-link active">
          <i class="fas fa-table me-2"></i>Админка
        </a>
      </li>
      <li class="nav-item">
        <a href="/user/profile" class="nav-link">
          <i class="fas fa-user me-2"></i>Пользователь
        </a>
      </li>
    </ul>
  </div>

  <div class="main-content">
    <h3 class="mb-4">Админ панель</h3>

    <ul class="nav nav-tabs">
      <li class="nav-item">
        <a class="nav-link active" data-bs-toggle="tab" href="#users">Пользователи</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#new-user">Новый пользователь</a>
      </li>
    </ul>

    <div class="tab-content">
      <div class="tab-pane fade show active" id="users">
        <h4 class="mb-4">Все пользователи</h4>
        <table class="table table-bordered table-hover">
          <thead class="table-light">
          <tr>
            <th>ID</th>
            <th>Имя</th>
            <th>Фамилия</th>
            <th>Возраст</th>
            <th>Email</th>
            <th>Роль</th>
            <th>Редактировать</th>
            <th>Удалить</th>
          </tr>
          </thead>
          <tbody id="usersTable">
          <!-- Пользователи будут загружены через JS -->
          </tbody>
        </table>
      </div>

      <div class="tab-pane fade" id="new-user">
        <h4 class="mb-4">Добавить нового пользователя</h4>
        <div class="admin-panel">
          <div class="form-container">
            <form id="userForm">
              <div class="form-group">
                <label class="bold">Имя</label>
                <input type="text" class="form-control" id="firstName" required>
                <div class="error-message" id="firstNameError"></div>
              </div>

              <div class="form-group">
                <label class="bold">Фамилия</label>
                <input type="text" class="form-control" id="lastName" required>
                <div class="error-message" id="lastNameError"></div>
              </div>

              <div class="form-group">
                <label class="bold">Возраст</label>
                <input type="number" class="form-control" id="age" required>
                <div class="error-message" id="ageError"></div>
              </div>

              <div class="form-group">
                <label class="bold">Email</label>
                <input type="email" class="form-control" id="email" required>
                <div class="error-message" id="emailError"></div>
              </div>

              <div class="form-group">
                <label class="bold">Пароль</label>
                <input type="password" class="form-control" id="password" required>
                <div class="error-message" id="passwordError"></div>
              </div>

              <div class="form-group">
                <label class="bold">Роль</label>
                <select class="d-none" multiple="multiple" name="roles" required id="rolesSelect">
                  <!-- Роли будут загружены через JS -->
                </select>

                <div class="role-items-container" id="rolesContainer">
                  <!-- Роли будут загружены через JS -->
                </div>
                <div class="error-message" id="rolesError" style="display: none;">Пожалуйста, выберите хотя бы одну роль</div>
              </div>

              <div class="button-container">
                <button type="submit" class="btn btn-success" onclick="validateRoles()">Добавить нового пользователя</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Модальное окно редактирования -->
    <div class="modal fade" id="editUserModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Редактировать пользователя</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <form id="editUserForm">
            <input type="hidden" id="editUserId">
            <div class="modal-body">
              <div class="form-group">
                <label>ID</label>
                <input type="text" class="form-control bg-light" id="editIdDisplay" readonly>
              </div>
              <div class="form-group">
                <label>Имя</label>
                <input type="text" class="form-control" id="editFirstName" required>
              </div>
              <div class="form-group">
                <label>Фамилия</label>
                <input type="text" class="form-control" id="editLastName" required>
              </div>
              <div class="form-group">
                <label>Возраст</label>
                <input type="number" class="form-control" id="editAge" required min="1">
              </div>
              <div class="form-group">
                <label>Email</label>
                <input type="email" class="form-control" id="editEmail" required>
              </div>
              <div class="form-group">
                <label>Пароль</label>
                <input type="password" class="form-control" id="editPassword">
              </div>

              <div class="form-group">
                <label>Роль</label>
                <select class="d-none" multiple="multiple" name="roles" required id="editRolesSelect">
                  <!-- Роли будут загружены через JS -->
                </select>
                <div class="role-items-container" id="editRolesContainer">
                  <!-- Роли будут загружены через JS -->
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
              <button type="submit" class="btn btn-primary">Сохранить изменения</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Модальное окно удаления -->
    <div class="modal fade" id="deleteUserModal" tabindex="-1" aria-labelledby="deleteUserModalLabel"
         aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Удалить пользователя</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3 text-center">
              <label for="deleteUserId" class="col-form-label fw-bold">ID:</label>
              <input type="text" class="form-control bg-light text-start" id="deleteUserId" readonly>
            </div>
            <div class="mb-3 text-center">
              <label for="deleteUserFirstName" class="col-form-label fw-bold">Имя:</label>
              <input type="text" class="form-control bg-light text-start" id="deleteUserFirstName" readonly>
            </div>
            <div class="mb-3 text-center">
              <label for="deleteUserLastName" class="col-form-label fw-bold">Фамилия:</label>
              <input type="text" class="form-control bg-light text-start" id="deleteUserLastName" readonly>
            </div>
            <div class="mb-3 text-center">
              <label for="deleteUserAge" class="col-form-label fw-bold">Возраст:</label>
              <input type="text" class="form-control bg-light text-start" id="deleteUserAge" readonly>
            </div>
            <div class="mb-3 text-center">
              <label for="deleteUserEmail" class="col-form-label fw-bold">Email:</label>
              <input type="text" class="form-control bg-light text-start" id="deleteUserEmail" readonly>
            </div>
            <div class="mb-3 text-center">
              <label for="deleteUserRole" class="col-form-label fw-bold">Роль:</label>
              <input type="text" class="form-control bg-light text-start" id="deleteUserRole" readonly>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Удалить</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  $(document).ready(function () {
    let allRoles = [];
    let currentUser = {};

    // Проверка аутентификации и загрузка данных
    checkAuthAndLoadData();

    // Обработчик кнопки выхода
    $('#logoutBtn').click(function() {
      fetch('/api/logout', {
        method: 'POST',
        credentials: 'include'
      }).then(response => {
        if (response.ok) {
          window.location.href = '/login';
        }
      });
    });

    // Обработчик отправки формы создания пользователя
    $('#userForm').submit(function(e) {
      e.preventDefault();
      createUser();
    });

    // Обработчик отправки формы редактирования пользователя
    $('#editUserForm').submit(function(e) {
      e.preventDefault();
      updateUser();
    });

    // Обработчик кнопки подтверждения удаления
    $('#confirmDeleteBtn').click(function() {
      deleteUser();
    });

    // Делегированные обработчики для кнопок редактирования и удаления
    $('#usersTable').on('click', '.edit-btn', function() {
      const userId = $(this).data('id');
      loadUserForEdit(userId);
    });

    $('#usersTable').on('click', '.delete-btn', function() {
      const userId = $(this).data('id');
      const firstName = $(this).data('firstname');
      const lastName = $(this).data('lastname');
      const age = $(this).data('age');
      const email = $(this).data('email');
      const roles = $(this).data('roles');

      showDeleteModal(userId, firstName, lastName, age, email, roles);
    });
  });

  function checkAuthAndLoadData() {
    fetch('/api/auth/check', {
      method: 'GET',
      headers: {
        'Accept': 'application/json'
      },
      credentials: 'include'
    })
            .then(response => {
              if (!response.ok) {
                window.location.href = '/login';
                throw new Error('Not authenticated');
              }
              return response.json();
            })
            .then(data => {
              if (!data.authenticated || !data.admin) {
                window.location.href = '/access-denied';
              }
              currentUser = data;
              updateCurrentUserInfo();
              loadAdminData();
            })
            .catch(error => {
              console.error('Error:', error);
            });
  }

  function updateCurrentUserInfo() {
    const roles = currentUser.roles.map(role => role.replace('ROLE_', '')).join(', ');
    $('#currentUserInfo').text(
            `${currentUser.email} с ролями: ${roles}`
    );
  }

  function loadAdminData() {
    fetch('/api/admin/users', {
      method: 'GET',
      headers: {
        'Accept': 'application/json'
      },
      credentials: 'include'
    })
            .then(response => {
              if (!response.ok) {
                if (response.status === 403) {
                  window.location.href = '/access-denied';
                } else {
                  throw new Error('Failed to load admin data');
                }
              }
              return response.json();
            })
            .then(data => {
              allRoles = data.allRoles;
              renderRoleCheckboxes();
              renderUsersTable(data.users);
            })
            .catch(error => {
              console.error('Error loading admin data:', error);
            });
  }

  function renderRoleCheckboxes() {
    const rolesContainer = $('#rolesContainer');
    const editRolesContainer = $('#editRolesContainer');
    const rolesSelect = $('#rolesSelect');
    const editRolesSelect = $('#editRolesSelect');

    // Очистка существующих опций
    rolesContainer.empty();
    editRolesContainer.empty();
    rolesSelect.empty();
    editRolesSelect.empty();

    // Добавление новых опций
    allRoles.forEach(role => {
      // Для формы создания пользователя
      const roleItem = $('<div></div>')
              .addClass('role-item')
              .attr('data-roleid', role.id)
              .html(`<span>${role.name.replace('ROLE_', '')}</span>`)
              .click(function() {
                $(this).toggleClass('selected');
                const option = rolesSelect.find(`option[value="${role.id}"]`);
                if (option) {
                  option.prop('selected', !option.prop('selected'));
                }
              });
      rolesContainer.append(roleItem);

      const option = $('<option></option>')
              .val(role.id)
              .text(role.name.replace('ROLE_', ''));
      rolesSelect.append(option);

      // Для формы редактирования
      const editRoleItem = roleItem.clone(true);
      editRoleItem.click(function() {
        $(this).toggleClass('selected');
        const option = editRolesSelect.find(`option[value="${role.id}"]`);
        if (option) {
          option.prop('selected', !option.prop('selected'));
        }
      });
      editRolesContainer.append(editRoleItem);

      const editOption = option.clone(true);
      editRolesSelect.append(editOption);
    });
  }

  function renderUsersTable(users) {
    const tableBody = $('#usersTable');
    tableBody.empty();

    users.forEach(user => {
      const roles = user.roles.map(role => role.replace('ROLE_', '')).join(' ');

      const row = $('<tr></tr>')
              .append(`<td>${user.id}</td>`)
              .append(`<td>${user.firstName}</td>`)
              .append(`<td>${user.lastName}</td>`)
              .append(`<td>${user.age}</td>`)
              .append(`<td>${user.email}</td>`)
              .append(`<td>${roles}</td>`)
              .append(`
                    <td>
                        <button class="btn btn-sm btn-edit edit-btn" data-id="${user.id}">
                            Редактировать
                        </button>
                    </td>
                `)
              .append(`
                    <td>
                        <button class="btn btn-sm btn-danger delete-btn"
                                data-id="${user.id}"
                                data-firstname="${user.firstName}"
                                data-lastname="${user.lastName}"
                                data-age="${user.age}"
                                data-email="${user.email}"
                                data-roles="${roles}">
                            Удалить
                        </button>
                    </td>
                `);

      tableBody.append(row);
    });
  }

  function createUser() {
    const selectedRoles = $('#rolesContainer .role-item.selected').map((index, item) => $(item).attr('data-roleid')).get();

    if (selectedRoles.length === 0) {
      $('#rolesError').show();
      return;
    } else {
      $('#rolesError').hide();
    }

    const userData = {
      firstName: $('#firstName').val(),
      lastName: $('#lastName').val(),
      age: $('#age').val(),
      email: $('#email').val(),
      password: $('#password').val(),
      roleIds: selectedRoles.map(Number)
    };

    fetch('/api/admin/users', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      credentials: 'include',
      body: JSON.stringify(userData)
    })
            .then(response => {
              if (!response.ok) {
                return response.json().then(err => Promise.reject(err));
              }
              return response.json();
            })
            .then(data => {
              loadAdminData();
              $('#userForm')[0].reset();
              $('#rolesContainer .role-item').removeClass('selected');
              alert('Пользователь успешно создан');
            })
            .catch(error => {
              console.error('Error:', error);
              if (error.errors) {
                displayValidationErrors(error.errors);
              } else {
                alert('Ошибка при создании пользователя');
              }
            });
  }

  function loadUserForEdit(userId) {
    fetch(`/api/admin/users/${userId}`, {
      method: 'GET',
      headers: {
        'Accept': 'application/json'
      },
      credentials: 'include'
    })
            .then(response => {
              if (!response.ok) {
                throw new Error('Failed to load user data');
              }
              return response.json();
            })
            .then(user => {
              $('#editUserId').val(user.id);
              $('#editIdDisplay').val(user.id);
              $('#editFirstName').val(user.firstName);
              $('#editLastName').val(user.lastName);
              $('#editAge').val(user.age);
              $('#editEmail').val(user.email);
              $('#editPassword').val('');

              // Очистка предыдущих выборов
              $('#editRolesContainer .role-item').removeClass('selected');

              // Выбор ролей пользователя
              user.roles.forEach(role => {
                const roleItem = $('#editRolesContainer .role-item[data-roleid="' + role.id + '"]');
                if (roleItem) {
                  roleItem.addClass('selected');
                }
              });

              // Открытие модального окна
              const modal = new bootstrap.Modal($('#editUserModal')[0]);
              modal.show();
            })
            .catch(error => {
              console.error('Error loading user for edit:', error);
              alert('Ошибка при загрузке данных пользователя');
            });
  }

  function updateUser() {
    const userId = $('#editUserId').val();
    const selectedRoles = $('#editRolesContainer .role-item.selected').map((index, item) => $(item).attr('data-roleid')).get();

    if (selectedRoles.length === 0) {
      alert('Пожалуйста, выберите хотя бы одну роль');
      return;
    }

    const userData = {
      firstName: $('#editFirstName').val(),
      lastName: $('#editLastName').val(),
      age: $('#editAge').val(),
      email: $('#editEmail').val(),
      password: $('#editPassword').val() || null,
      roleIds: selectedRoles.map(Number)
    };

    fetch(`/api/admin/users/${userId}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      credentials: 'include',
      body: JSON.stringify(userData)
    })
            .then(response => {
              if (!response.ok) {
                return response.json().then(err => Promise.reject(err));
              }
              return response.json();
            })
            .then(data => {
              loadAdminData();
              const modal = bootstrap.Modal.getInstance($('#editUserModal')[0]);
              modal.hide();
              alert('Пользователь успешно обновлен');
            })
            .catch(error => {
              console.error('Error:', error);
              if (error.errors) {
                displayValidationErrors(error.errors, true);
              } else {
                alert('Ошибка при обновлении пользователя');
              }
            });
  }

  function showDeleteModal(id, firstName, lastName, age, email, roles) {
    $('#deleteUserId').val(id);
    $('#deleteUserFirstName').val(firstName);
    $('#deleteUserLastName').val(lastName);
    $('#deleteUserAge').val(age);
    $('#deleteUserEmail').val(email);
    $('#deleteUserRole').val(roles);

    const modal = new bootstrap.Modal($('#deleteUserModal')[0]);
    modal.show();
  }

  function deleteUser() {
    const userId = $('#deleteUserId').val();

    fetch(`/api/admin/users/${userId}`, {
      method: 'DELETE',
      credentials: 'include'
    })
            .then(response => {
              if (!response.ok) {
                throw new Error('Failed to delete user');
              }
              return response.json();
            })
            .then(data => {
              loadAdminData();
              const modal = bootstrap.Modal.getInstance($('#deleteUserModal')[0]);
              modal.hide();
              alert('Пользователь успешно удален');
            })
            .catch(error => {
              console.error('Error:', error);
              alert('Ошибка при удалении пользователя');
            });
  }

  function displayValidationErrors(errors, isEditForm = false) {
    // Очистка предыдущих ошибок
    $('.error-message').text('');

    // Отображение новых ошибок
    for (const field in errors) {
      const errorElement = $(isEditForm ? `#edit${field.charAt(0).toUpperCase() + field.slice(1)}Error` : `#${field}Error`);
      if (errorElement) {
        errorElement.text(errors[field]);
      }
    }
  }

  function validateRoles() {
    const selectedRoles = $('#rolesContainer .role-item.selected').map((index, item) => $(item).attr('data-roleid')).get();
    if (selectedRoles.length === 0) {
      $('#rolesError').show();
      return false;
    }
    $('#rolesError').hide();
    return true;
  }
</script>
</body>
</html>
